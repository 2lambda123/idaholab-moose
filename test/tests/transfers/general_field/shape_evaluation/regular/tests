[Tests]
  issues = '#16427 #16429'
  design = 'transfers/MultiAppGeneralFieldShapeEvaluationTransfer.md'

  [2d_overlay]
    requirement = "The system shall be able to transfer variables by evaluating shape functions in the origin problem"
    [same_var_type]
      type = 'Exodiff'
      input = 'main.i'
      exodiff = 'main_out.e main_out_sub0_out.e main_out_sub1_out.e main_out_sub2_out.e'
      detail = "for variables of the same type,"
    []

    [projection_needed_receiving]
      type = 'Exodiff'
      input = 'main.i'
      exodiff = 'projection_receive.e projection_receive_sub0_out.e projection_receive_sub1_out.e projection_receive_sub2_out.e'
      # Set various types of finite element families to the received variables in both apps
      cli_args = "Outputs/file_base=projection_receive Mesh/second_order=true
                  AuxVariables/from_sub/order=SECOND AuxVariables/from_sub_elem/order=SECOND
                  MultiApps/sub/cli_args='Mesh/second_order=true;AuxVariables/from_main/order=SECOND;AuxVariables/from_main_elem/order=FIRST'"
      detail = "for variables of arbitrary types,"
    []

    [projection_needed_sending]
      type = 'Exodiff'
      input = 'main.i'
      exodiff = 'projection_send.e projection_send_sub0_out.e projection_send_sub1_out.e projection_send_sub2_out.e'
      # Set various types of finite element families to the transfered variables in both apps
      cli_args = "Outputs/file_base=projection_send Mesh/second_order=true
                  AuxVariables/to_sub/order=SECOND AuxVariables/to_sub_elem/order=SECOND
                  MultiApps/sub/cli_args='Mesh/second_order=true;AuxVariables/to_main/order=FIRST;AuxVariables/to_main_elem/order=SECOND'"
      detail = "for variables of arbitrary types,"
    []

    [multiple_variables_each_transfer]
      type = Exodiff
      input = main.i
      exodiff = 'main_out.e main_out_sub0_out.e main_out_sub1_out.e main_out_sub2_out.e'
      # Only use one transfer block for each direction
      cli_args = "Transfers/active='from_sub to_sub'
                  Transfers/from_sub/source_variable='to_main to_main_elem' Transfers/from_sub/variable='from_sub from_sub_elem'
                  Transfers/to_sub/source_variable='to_sub to_sub_elem' Transfers/to_sub/variable='from_main from_main_elem'"
      detail = "when specifying multiple variables in a single transfer"
    []
  []

  [errors]
    requirement = "The system shall return an error if"
    [wrong_variable_numbers]
      type = RunException
      input = main.i
      cli_args = "Transfers/active='from_sub'
                  Transfers/from_sub/source_variable='to_main to_main_elem' Transfers/from_sub/variable='from_sub_elem'"
      expect_err = "The number of variables to transfer to and from should be equal"
      detail = 'a different number of variables is specified for the source and target variables of the transfer.'
    []
  []

  [overlap]
    requirement = "The system shall be able to detect indetermination in a transfer due to"
    [origin_mesh]
      type = RunException
      input = main.i
      # We offset them a little, because overlaps when the transferred value is the same are not counted as overlaps
      cli_args = "Transfers/active='from_sub' Transfers/from_sub/search_value_conflicts=true MultiApps/sub/positions='0 0 0 0.0001 0 0'"
      expect_err = "multiple valid values from equidistant points were "
      detail = 'overlapping origin child application, causing multiple shape evaluations to be valid'
      # Both apps need to be on the same process
      max_parallel = 1
    []

    [multiple_received_values]
      type = RunException
      input = main.i
      # The child apps overlap and send multiple valid points for each target point on the destination app (parent)
      cli_args = "Transfers/active='from_sub' Transfers/from_sub/search_value_conflicts=true MultiApps/sub/positions='0 0 0 0.01 0 0'"
      expect_err = "multiple valid values from equidistant points were received"
      detail = 'multiple source problems sending valid values for a given target point'
      # One app per process
      min_parallel = 2
    []
  []
[]
