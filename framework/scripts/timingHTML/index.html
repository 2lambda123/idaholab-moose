<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Moose Test Timing</title>
    <link href="resources/jquery.css" rel="stylesheet" type="text/css">
    <!--[if IE]><script language="javascript" type="text/javascript" src="resources/excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="resources/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="resources/jquery.flot.min.js"></script>
    <script language="javascript" type="text/javascript" src="resources/jquery.flot.selection.min.js"></script>
    <script language="javascript" type="text/javascript" src="resources/jquery-ui-1.8.2.custom.min.js"></script>

    <style type="text/css">
    .test { width: 300px; float: left; overflow: hidden;}
    .ui-tabs { padding: .2em; zoom: 1; font-size: 80% !important; }
    </style>
 </head>
    <body>
    <h1>Moose Test Timing</h1>

    <!-- jquery tabs plugin. These will fetch data to display from the link provided -->
    <!-- IMPORTANT: these need to be in the same order as the TAB_NAMES variable -->
    <div id="testTabs">
      <ul>
        <li><a href="moose_test/moose_test.html"><span>MOOSE Test</span></a></li>
        <li><a href="bison/bison.html"><span>BISON</span></a></li>
        <li><a href="bighorn/bighorn.html"><span>BIGHORN</span></a></li>
        <li><a href="marmot/marmot.html"><span>MARMOT</span></a></li>
        <li><a href="rat/rat.html"><span>RAT</span></a></li>
        <li><a href="falcon/falcon.html"><span>FALCON</span></a></li>
        <li><a href="emu/emu.html"><span>EMU</span></a></li>
        <li><a href="jackalope/jackalope.html"><span>JACKALOPE</span></a></li>
        <li><a href="elk/elk.html"><span>ELK</span></a></li>
      </ul>
    </div>
    <br clear="all"/>

    <div style="float:left">
      <div id="mainplot" style="width:700px;height:300px"></div>
    </div>
    

    <div id="miniature" style="float:left;margin-left:20px;margin-top:0px">
      <div id="minplot" style="width:300px;height:150px"></div>
      <p id="minplotLegend" style="margin-left:10px"></p>
    </div>
    
    <br clear="all"/><br/>
    <button id="zoom"  type="button">Zoom Out</button>
    <button id="clear" type="button">Clear Plots</button>
    <button id="tooltip" type="button">Enable Tooltip</button>
    Plot by: <select id="plotby"><option value="rev">Revision</option><option value="time">Time</option></select>

    <br clear="all"/><br/>
    <div id="data">
      <table border="0">
      <tr title="Application this test resides in"><td><b>App:</b></td><td id="tb_app">moose_test</td></tr>
      <tr title="Tests .py file and function name"><td><b>Test:</b></td><td id="tb_test">2d_diffustion_test</td></tr>
      <tr title="Revision that was checked out to run the test"><td><b>Revision:</b></td><td id="tb_rev">2120</td></tr>
      <tr title="Time it took the test to execute"><td><b>Time:</b></td><td id="tb_timing">16.4 secs</td></tr>
      <tr title="Approx. time the test was run"><td><b>Date:</b></td><td id="tb_date">08/06/2010</td></tr>
      <tr title="Dofs passed to run_tests script with --dofs"><td><b>Dofs:</b></td><td id="tb_dofs">5000</td></tr>
      <tr title="Load average of the server when the test was run"><td><b>Load Average:</b></td><td id="tb_load">4.3</td></tr>
      </table>
    </div>

<script id="source">
var TAB_NAMES = ["moose_test", "bison", "bighorn", "marmot", "rat", "falcon", "emu", "jackalope", "elk"];

var global_plots = {};

var loaded_plots = {};

var global_data = [];

var plot;
var minplot;

//options for the main plot
var main_options = {
    legend: { show: false },
    series: {
        lines: { show: true },
        points: { show: true }
    },
    yaxis: { ticks: 5,
             tickFormatter: function(val, axis) { return val.toFixed(axis.tickDecimals) + "s"; }
           },
    xaxis: { minTickSize: 1, tickDecimals: 0 },
    grid: { color: "#999" },
    selection: { mode: "xy" }
};

//options for the miniature plot
var min_options = {
    legend: { show: true, container: $("#minplotLegend") },
    series: {
        lines: { show: true, lineWidth: 1 },
        shadowSize: 0
    },
    xaxis: { ticks: 3 },
    yaxis: { ticks: 3 },
    grid: { color: "#999" },
    selection: { mode: "xy" }
};

//utility function that returns the app name of the currently selected tab,
//ie "rat" or "bison"
function getAppName() {
  var selected = $("#testTabs").tabs( "option", "selected" );
  return TAB_NAMES[selected];
}

//utility function that returns what the plot is plotting by, it is used to
//construct the url to the data. Returns "rev" for revision or "time"
function getPlotBy() {
  return "rev";
}

//this function is the ajax callback when new plot data is received
function onDataReceived(series) {
  //reconstruct the url, the label is appname.testname
  label = series["byrev"]["label"];
  pt = label.indexOf(".");
  url = label.substring(0,pt) + "/" + label.substring(pt+1) + ".json";
  //alert("Received: " + url);
  loaded_plots[url] = series["byrev"];
  global_plots[url] = series["byrev"];
  redrawPlotData();
}

//utility function to plot all the data in global_plots
function redrawPlotData() {
  global_data = [];
  for (var key in global_plots)
    global_data.push(global_plots[key]);

  //TODO: save ranges and keep plot in the same range
  savedxaxis = minplot.getAxes().xaxis;
  savedyaxis = minplot.getAxes().yaxis;

  plot = $.plot($("#mainplot"), global_data, main_options);
  minplot = $.plot($("#minplot"), global_data, min_options);
}

//this function is called when a checkbox is clicked, it adds ore removes a plot
function checkboxClickCallback(event) {
  appName = getAppName();
  plotBy = getPlotBy();
  testName = this.id;
  url = appName + "/" + testName + ".json";
  //alert(url);

  // if it's checked, add the data to the plot
  if (this.checked)
  {
    if (url in loaded_plots)
    {
      global_plots[url] = loaded_plots[url];
      redrawPlotData();
    }
    else
    {
      //alert("Fetching: " + url);
      $.ajax({
        url: url,
        method: "GET",
        dataType: "json",
        success: onDataReceived
      });
    }
  }
  else // remove the data from the plot
  {
    delete global_plots[url];
    redrawPlotData();
  }
}

//this function is called after a tab is loaded, it binds the click
//callback to newly loaded checkboxes
function tabLoadCallback(event, ui) {
  //unbind the function from the click event because there are past checkboxes
  //that already have a function bound to it, then bind it again to everything
  $(".check").unbind("click", checkboxClickCallback);
  $(".check").click(checkboxClickCallback);
}

//this function is called when the document is ready
$(function () {
  //make the tabs
  $("#testTabs").tabs({ load: tabLoadCallback,
                        cache: true });

  plot = $.plot($("#mainplot"), [], main_options);
  minplot = $.plot($("#minplot"), [], min_options);

  // now connect the two
  
  $("#mainplot").bind("plotselected", function (event, ranges) {
      // clamp the zooming to prevent eternal zoom
      if (ranges.xaxis.to - ranges.xaxis.from < 0.00001)
          ranges.xaxis.to = ranges.xaxis.from + 0.00001;
      if (ranges.yaxis.to - ranges.yaxis.from < 0.00001)
          ranges.yaxis.to = ranges.yaxis.from + 0.00001;
      
      // do the zooming
      plot = $.plot($("#mainplot"), global_data,
                    $.extend(true, {}, main_options, {
                        xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to },
                        yaxis: { min: ranges.yaxis.from, max: ranges.yaxis.to }
                    }));
      
      // dont fire event on the minplot to prevent eternal loop
      minplot.setSelection(ranges, true);
  });
  $("#minplot").bind("plotselected", function (event, ranges) {
      plot.setSelection(ranges);
  });

  //bind a function to the "Clear Plots" button
  $("#clear").click(function(event) {
    //remove plot data from global structure
    for (key in global_plots)
      delete global_plots[key];

    //uncheck all the checkboxes
    $(".check").each(function(index) {
      this.checked = false;
    });
    redrawPlotData();
  });

  //bind a function to the "Zoom Out" button
  $("#zoom").click(function(event) {
    //get the maximum range from the minplot
    savedxaxis = minplot.getAxes().xaxis;
    savedyaxis = minplot.getAxes().yaxis;
    //alert( "("+savedxaxis.min+","+savedyaxis.min+") ("+savedxaxis.max+","+savedyaxis.max+")" );
    range = { xaxis: { to: savedxaxis.min, from: savedxaxis.max },
              yaxis: { to: savedyaxis.min, from: savedyaxis.max } }
    plot.setSelection(range);
  });

  //bind a function to the "Enable Tooltip" button
  $("#tooltip").click(function(event) {
    alert("TBD");
  });

  //bind a function to the "Plot By" select box
  $("#plotby").change(function() {
    plotby = $("#plotby").val();
    if (plotby === "time") {
      main_options.xaxis.mode = "time";
      min_options.xaxis.mode = "time";
      delete main_options.xaxis["minTickSize"];
      delete main_options.xaxis["tickDecimals"];
    }
    else { //plot by revision
      main_options.xaxis.mode = null;
      min_options.xaxis.mode = null;
      main_options.xaxis["minTickSize"] = 1;
      main_options.xaxis["tickDecimals"] = 0;
    }
    redrawPlotData();
  });

  //TODO: simulate click on first checkbox in DOM
  //TODO: move this in ontabload callback with flag for first time
  //$(".check").first().click();
});
</script>

 </body>
</html>
